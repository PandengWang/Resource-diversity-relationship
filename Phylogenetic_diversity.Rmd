---
title: "Look for new ideas"
output: html_notebook
---


```{r Load packages}
library(ggplot2); packageVersion("ggplot2")
library(plotrix)
library(nlme)
library(RColorBrewer)
library(GAD)
library(tidyverse)
library(ggrepel)
library(plotly)
library(reshape)
library(plotly)
library(reshape2)

```


## In case I want to use a dataset in which I removed uncharacterized bacteria (= ASVs identified just as bacteria)

```{r}
ps_to_use_AllKnown <- subset_taxa(ps_to_use, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))

D0 <- estimate_richness(ps_to_use_AllKnown,split=TRUE, measures="Observed")
shannon_Silva <- estimate_richness(ps_to_use_AllKnown, measures="Shannon")
D1 <- exp(shannon_Silva)
simpson_div_Silva <- estimate_richness(ps_to_use_AllKnown, measures="Simpson")
D2 <- estimate_richness(ps_to_use_AllKnown, measures="InvSimpson")
ACE <- estimate_richness(ps_to_use_AllKnown, measures="ACE")
FaithPD <- estimate_richness_custom(ps_to_use_AllKnown, measures="FaithPD")
std_PD <- FaithPD/D0

# Create a factor corresponding to the Family
fam_fac = factor(tax_table(ps_to_use_AllKnown)[, "Family"])

# Tabulate the counts for each genera in each sample
fam_tab = apply(t(otu_table(ps_to_use_AllKnown)), MARGIN = 2, function(x) {
  tapply(x, INDEX = fam_fac, FUN = sum, na.rm = TRUE, simplify = TRUE)
})
#head(fam_tab)[, 1:10]

# To get number of non-zero families per sample, sum the values that are above your threshold, in my case, 1.
observationThreshold = 1
fam_richness <- apply(fam_tab > observationThreshold, 2, sum)

ps_to_use_AllKnown_RA <-  transform_sample_counts(ps_to_use_AllKnown, function(x) {x / sum(x)} )  # transform to relative abundance
df_AllKnown_RA <- psmelt(ps_to_use_AllKnown_RA)  #melt

count_fun <- function(x){
  sum(x>0.001) 
}
sp.rich_0.1 <- by(df_AllKnown_RA$Abundance, df_AllKnown_RA$Sample, count_fun, simplify=TRUE)
sp.rich_0.1_bis <- lapply(sp.rich_0.1 , mean)
sp.rich_0.1_unlisted <- unlist(sp.rich_0.1_bis)

diversity_AllKnown_data <- data.frame(sample_data(ps_to_use_AllKnown), D0 = D0$Observed, D1 = D1$Shannon, D2 = D2$InvSimpson, shannon = shannon_Silva$Shannon, FaithPD = FaithPD$FaithPD, OD=OD_data$OD*10, D0_family=fam_richness, D0_0.1=sp.rich_0.1_unlisted, std_PD = std_PD$FaithPD)

diversity_AllKnown_tib <- as_tibble(diversity_AllKnown_data )

```



# Phylogenetic Diversity

### Aggregate data by medium
Each combination of carbon sources (growth medium) is replicated 3 times. 

```{r}
myDat <- diversity_AllKnown_tib  # or diversity_tib for all ASVs or diversity_AllKnown_tib

PD_tib <- myDat %>%
   group_by(medium, FC_number, C_number) %>%
   summarise(mean_PD = mean(FaithPD),
             SE_PD = std.error(FaithPD))

# create numeric variable for medium 
PD_tib$medium_id <- as.numeric(levels(PD_tib$medium))[PD_tib$medium]

```

### PD in single resources

```{r}
PD_1C <- filter(PD_tib, C_number == 1)  # subset dataset

PD_1C <- PD_1C %>%
  mutate(resource = case_when(medium=="43"~"glucose",
                            medium=="44"~"fructose",
                            medium=="45"~"xylose",
                            medium=="46"~"mannose",
                            medium=="47"~"cellobiose",
                            medium=="48"~"maltose",
                            medium=="49"~"sucrose",
                            medium=="50"~"citrate",
                            medium=="51"~"fumarate",
                            medium=="52"~"galacturonate",
                            medium=="53"~"mannitol",
                            medium=="54"~"sorbitol",
                            medium=="55"~"glycerol",
                            medium=="56"~"proline",
                            medium=="57"~"cellulose",
                            medium=="58"~"starch"
                            ))

PD_1C <- PD_1C %>%
  arrange(mean_PD)
PD_1C$asc_ordering <- c(letters[1:16])

p_PD_1C <- ggplot(data=PD_1C, aes(x=asc_ordering, y=mean_PD, fill=medium)) +
  geom_bar(data=PD_1C, aes(x=asc_ordering, y=mean_PD, fill=medium), stat="identity", alpha=.8, width=.4) +
  geom_errorbar(data=PD_1C, aes(x=asc_ordering, y=mean_PD, fill=medium, ymin=mean_PD-SE_PD, ymax=mean_PD+SE_PD), width=0, position=position_identity()) +
  theme_light() +
  # coord_flip() +
  # scale_x_reverse() +
  scale_fill_manual(values = colorRampPalette(brewer.pal(21, "Spectral"))(16)) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position="none"
  )
p_PD_1C

```
### Compare with richness

```{r}
myDat <- diversity_tib

meanRich_tib <- myDat %>%
   group_by(medium, FC_number, C_number) %>%
   summarise(mean_rich = mean(D0),
             SE_rich = std.error(D0))

# create numeric variable for medium 
meanRich_tib$medium_id <- as.numeric(levels(meanRich_tib$medium))[meanRich_tib$medium]

meanRich_1C <- filter(meanRich_tib, C_number == 1)  # subset dataset

meanRich_1C <- meanRich_1C %>%
  arrange(mean_rich)
meanRich_1C$asc_ordering <- c(letters[1:16])

p_meanRich_1C <- ggplot(data=meanRich_1C, aes(x=asc_ordering, y=mean_rich, fill=medium)) +
  geom_bar( stat="identity", alpha=.8, width=.4) +
  geom_errorbar(aes(x=asc_ordering, y=mean_rich, fill=medium, ymin=mean_rich-SE_rich, ymax=mean_rich+SE_rich), width=0, position=position_identity()) +
  theme_light() +
  # coord_flip() +
  # scale_x_reverse() +
  scale_fill_manual(values = colorRampPalette(brewer.pal(21, "Spectral"))(16)) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position="none"
  )
p_meanRich_1C
```



### PD in 2-resource communities

```{r}
PD_2C <- filter(PD_tib, C_number == 2)  # subset dataset

PD_2C <- PD_2C %>%
  mutate(resource = case_when(medium=="1"~"glucose-proline",
                            medium=="2"~"maltose-fumarate",
                            medium=="3"~"galacturonate-sucrose",
                            medium=="4"~"sorbitol-cellulose",
                            medium=="8"~"cellobiose-fructose",
                            medium=="9"~"citrate-mannose",
                            medium=="10"~"xilose-mannitol",
                            medium=="11"~"glycerol-starch",
                            medium=="15"~"glycerol-xylose",
                            medium=="16"~"sorbitol-mannose",
                            medium=="17"~"cellobiose-glucose",
                            medium=="18"~"cellulose-fructose",
                            medium=="22"~"starch-mannitol",
                            medium=="23"~"fumarate-galacturonate",
                            medium=="24"~"maltose-citrate",
                            medium=="25"~"sucrose-proline",
                            medium=="29"~"proline-fumarate",
                            medium=="30"~"citrate-glycerol",
                            medium=="31"~"starch-fructose",
                            medium=="32"~"cellulose-glucose",
                            medium=="36"~"sucrose-maltose",
                            medium=="37"~"galacturonate-cellobiose",
                            medium=="38"~"mannose-xylose",
                            medium=="39"~"sorbitol-mannitol"
                            ))

PD_2C <- PD_2C %>%
  arrange(mean_PD)
PD_2C$asc_ordering <- c(letters[1:24])

p_PD_2C <- ggplot(data=PD_2C, aes(x=asc_ordering, y=mean_PD, fill=medium)) +
  geom_bar(data=PD_2C, aes(x=asc_ordering, y=mean_PD, fill=medium), stat="identity", alpha=.8, width=.4) +
  geom_errorbar(data=PD_2C, aes(x=asc_ordering, y=mean_PD, fill=medium, ymin=mean_PD-SE_PD, ymax=mean_PD+SE_PD), width=0, position=position_identity()) +
  theme_light() +
  # coord_flip() +
  # scale_x_reverse() +
  scale_fill_manual(values = colorRampPalette(brewer.pal(24, "Spectral"))(24)) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position="none"
  )
p_PD_2C
```

### Connecting constuent singles to pairs (PD)

```{r}
PD_1_2C <- filter(PD_tib, C_number == 1 | C_number == 2)

PD_1_2C <- PD_1_2C %>%
  mutate(resource = case_when(medium=="43"~"glucose",
                            medium=="44"~"fructose",
                            medium=="45"~"xylose",
                            medium=="46"~"mannose",
                            medium=="47"~"cellobiose",
                            medium=="48"~"maltose",
                            medium=="49"~"sucrose",
                            medium=="50"~"citrate",
                            medium=="51"~"fumarate",
                            medium=="52"~"galacturonate",
                            medium=="53"~"mannitol",
                            medium=="54"~"sorbitol",
                            medium=="55"~"glycerol",
                            medium=="56"~"proline",
                            medium=="57"~"cellulose",
                            medium=="58"~"starch",
                            medium=="1"~"glucose-proline",
                            medium=="2"~"maltose-fumarate",
                            medium=="3"~"galacturonate-sucrose",
                            medium=="4"~"sorbitol-cellulose",
                            medium=="8"~"cellobiose-fructose",
                            medium=="9"~"citrate-mannose",
                            medium=="10"~"xilose-mannitol",
                            medium=="11"~"glycerol-starch",
                            medium=="15"~"glycerol-xylose",
                            medium=="16"~"sorbitol-mannose",
                            medium=="17"~"cellobiose-glucose",
                            medium=="18"~"cellulose-fructose",
                            medium=="22"~"starch-mannitol",
                            medium=="23"~"fumarate-galacturonate",
                            medium=="24"~"maltose-citrate",
                            medium=="25"~"sucrose-proline",
                            medium=="29"~"proline-fumarate",
                            medium=="30"~"citrate-glycerol",
                            medium=="31"~"starch-fructose",
                            medium=="32"~"cellulose-glucose",
                            medium=="36"~"sucrose-maltose",
                            medium=="37"~"galacturonate-cellobiose",
                            medium=="38"~"mannose-xylose",
                            medium=="39"~"sorbitol-mannitol"
                            ))

p_arrow_1_2 <- ggplot(data=PD_1_2C, aes(C_number, y=mean_PD, group=C_number, label= resource))+
  geom_boxplot(alpha=0.6)+
  geom_point(size=2)+
  geom_text_repel(size=2, hjust=0, vjust=0)+
  theme_light()
p_arrow_1_2

```


### PD as a function of the number of C sources

```{r}
PD_nC <- PD_tib  %>%
   group_by(FC_number, C_number) %>%
   summarise(mean_PD_1 = mean(mean_PD),
             SE_PD = std.error(mean_PD))

p_PD <- ggplot(data=PD_nC , aes(x=C_number, y=mean_PD_1))+
  geom_jitter(data=PD_nC, aes(x=C_number, y=mean_PD_1), size=3, shape=21, fill="gray", width=0.1)+
  geom_point(size=6, shape=21)+
  geom_errorbar(data=PD_nC,aes(x=C_number, y=mean_PD_1, ymin=mean_PD_1-SE_PD, ymax=mean_PD_1+SE_PD))+
  #geom_point(size=4, shape=22)+
  theme_bw()+
  theme(legend.position="none")+
  ylim(0,0.5)
p_PD
```

# with richness

```{r}
PD_nC <- PD_tib %>%
   group_by(FC_number, C_number) %>%
   summarise(mean_PD_1 = mean(mean_PD),
             SE_PD = std.error(mean_PD))

p_PD <- ggplot(data=PD_nC , aes(x=C_number, y=mean_PD_1))+
  geom_jitter(data=PD_tib, aes(x=C_number, y=mean_PD), size=3, shape=21, fill="gray", width=0.1)+
  geom_point(size=6, shape=21)+
  geom_errorbar(data=PD_nC,aes(x=C_number, y=mean_PD_1, ymin=mean_PD_1-SE_PD, ymax=mean_PD_1+SE_PD))+
  #geom_point(size=4, shape=22)+
  theme_bw()+
  theme(legend.position="none")+
  ylim(0,15)
p_PD
```

### STD_PD (PD divided by richness)

```{r}
myDat <- diversity_AllKnown_tib

stdPD_tib <- myDat %>%
   group_by(medium, FC_number, C_number) %>%
   summarise(mean_stdPD = mean(std_PD),
             SE_stdPD = std.error(std_PD))

# create numeric variable for medium 
stdPD_tib$medium_id <- as.numeric(levels(stdPD_tib$medium))[stdPD_tib$medium]

stdPD_tib_1C <- filter(stdPD_tib, C_number == 1)  # subset dataset

stdPD_tib_1C <- stdPD_tib_1C %>%
  mutate(resource = case_when(medium=="43"~"glucose",
                            medium=="44"~"fructose",
                            medium=="45"~"xylose",
                            medium=="46"~"mannose",
                            medium=="47"~"cellobiose",
                            medium=="48"~"maltose",
                            medium=="49"~"sucrose",
                            medium=="50"~"citrate",
                            medium=="51"~"fumarate",
                            medium=="52"~"galacturonate",
                            medium=="53"~"mannitol",
                            medium=="54"~"sorbitol",
                            medium=="55"~"glycerol",
                            medium=="56"~"proline",
                            medium=="57"~"cellulose",
                            medium=="58"~"starch"
                            ))

stdPD_tib_1C <- stdPD_tib_1C %>%
  arrange(mean_stdPD)
stdPD_tib_1C$asc_ordering <- c(letters[1:16])

p_stdPD_1C <- ggplot(data=stdPD_tib_1C, aes(x=asc_ordering, y=mean_stdPD, fill=medium)) +
  geom_bar( stat="identity", alpha=.8, width=.4) +
  geom_errorbar(aes(x=asc_ordering, y=mean_stdPD, fill=medium, ymin=mean_stdPD-SE_stdPD, ymax=mean_stdPD+SE_stdPD), width=0, position=position_identity()) +
  theme_light() +
  # coord_flip() +
  # scale_x_reverse() +
  scale_fill_manual(values = colorRampPalette(brewer.pal(21, "Spectral"))(16)) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position="none"
  )
p_stdPD_1C
```

```{r}
stdPD_nC <- stdPD_tib  %>%
   group_by(FC_number, C_number) %>%
   summarise(mean_PD_1 = mean(mean_stdPD),
             SE_PD = std.error(mean_stdPD))

p_PD <- ggplot(data=stdPD_nC , aes(x=C_number, y=mean_PD_1))+
  geom_jitter(data=stdPD_nC, aes(x=C_number, y=mean_PD_1), size=3, shape=21, fill="gray", width=0.1)+
  geom_point(size=6, shape=21)+
  geom_errorbar(data=stdPD_nC,aes(x=C_number, y=mean_PD_1, ymin=mean_PD_1-SE_PD, ymax=mean_PD_1+SE_PD))+
  #geom_point(size=4, shape=22)+
  theme_bw()+
  theme(legend.position="none")+
  ylim(0,0.5)
p_PD

```


### what happens when I take into account the # of gluconeogenic and glycolytic resources separately?

```{r}
count_fun <- function(x){
  sum(x>0) 
}

myDat <- myDat %>%
   mutate(gluc_number = select(., citric_acid_c, fumaric_acid_c, proline_c) %>% apply(1, count_fun),
          glyc_number = select(.,glucose_c, fructose_c, xylose_c, mannose_c, cellobiose_c, maltose_c, sucrose_c, galacturonic_acid_c, mannitol_c, sorbitol_c, glycerol_c, cellulose_c, starch_c) %>% apply(1, count_fun))

PD_tib_2 <- myDat %>%
   group_by(gluc_number,glyc_number,medium, FC_number, C_number) %>%
   summarise(mean_PD = mean(FaithPD),
             SE_PD = std.error(FaithPD))

LM.1 <- lm(mean_rich~gluc_number + glyc_number, data=PD_tib_2)
summary(LM.1)

LM.2 <- lm(mean_PD~C_number, data=PD_tib_2)
#summary(LM.2)

AIC(LM.1, LM.2)

```

#3D plot with plotly

https://stackoverflow.com/questions/38331198/add-regression-plane-to-3d-scatter-plot-in-plotly

```{r}
my_df <- PD_tib_2
graph_reso <- 0.05

#Setup Axis
axis_x <- seq(min(my_df$glyc_number), max(my_df$glyc_number), by = graph_reso)
axis_y <- seq(min(my_df$gluc_number), max(my_df$gluc_number), by = graph_reso)

#Sample points
LM.1_surface <- expand.grid(glyc_number = axis_x,gluc_number = axis_y,KEEP.OUT.ATTRS = F)
LM.1_surface$pred_rich <- predict.lm(LM.1, newdata = LM.1_surface)
LM.1_surface <- acast(LM.1_surface, gluc_number ~ glyc_number, value.var = "pred_rich") #y ~ x

threeD_plot <- plot_ly(my_df, 
                     x = ~glyc_number, 
                     y = ~gluc_number, 
                     z = ~mean_PD,
                     text = ~C_number, 
                     type = "scatter3d", 
                     mode = "markers",
                     color= ~FC_number,
                     colors = c("#C2294A", "#FA9856", "#FEE08B", "#E6F598", "#94D4A4", "#4075B4")
                     )

threeD_PD_plot <- add_trace(p = threeD_plot,
                       z = LM.1_surface,
                       x = axis_x,
                       y = axis_y,
                       type = "surface", 
                       colorscale = "YlGnBu",
                       reversescale =T)

threeD_PD_plot
```


Known palettes: "Blackbody", "Bluered", "Blues", "Earth", "Electric", "Greens", "Greys", "Hot", "Jet", "Picnic", "Portland", "Rainbow", "RdBu", "Reds", "Viridis", "YlGnBu", "YlOrRd".









